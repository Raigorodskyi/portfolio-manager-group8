<div class="dashboard-container">
  <div class="dashboard-header">
    <div class="header-top">
      <h1><a href="#">My Portfolio</a></h1>
      <nav>
        <a routerLink="/stocks" class="active">Stocks</a>
        <a routerLink="/bonds">Bonds</a>
        <a routerLink="/profile">Profile</a>
        <a href="#">Overview</a>
      </nav>
    </div>
  </div>

  <!-- VALUE BOXES are now separate -->
  <div class="portfolio-values-boxes">
    <div class="value-card">
      <h3>Portfolio Value</h3>
      <p class="main-value">${{ globalValue | number: '1.2-2' }}</p>
    </div>

    <div class="value-card">
      <h3>Net Stock Valuation</h3>
      <p class="main-value">${{ stocksValuation | number: '1.2-2' }}</p>
    </div>
  </div>

  <!-- Profit gain/loss sentence -->
  <div class="portfolio-profit-box">
    <p [ngClass]="getTotalStockChange() >= 0 ? 'gain-text' : 'loss-text'">
      Your portfolio has
      {{ getTotalStockChange() >= 0 ? 'gained' : 'lost' }}
      <strong>{{ getTotalStockChange() | currency }}</strong>
      from stocks.
    </p>
  </div>
  <div class="dashboard-grid">
    <div class="your-stocks-box">
      <h2>Your Stocks</h2>
      <table>
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Name</th>
            <th>Shares</th>
            <th>Purchase Price</th>
            <th>Current Price</th>
            <th>Difference</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let stock of stockList">
            <td>{{ stock.data.stock_ticker }}</td>
            <td>{{ stock.data.stock_name }}</td>
            <td>{{ stock.data.shares }}</td>
            <td>{{ stock.data.purchase_price | currency }}</td>
            <td>{{ stock.data.current_price | currency }}</td>
            <td>
              <span
                [ngClass]="getGainLoss(stock.data) >= 0 ? 'gain' : 'loss'"
                class="gain-loss-cell"
              >
                {{ getGainLoss(stock.data) | currency }}
                <span class="material-symbols-outlined">
                  {{
                    getGainLoss(stock.data) >= 0
                      ? "trending_up"
                      : "trending_down"
                  }}
                </span>
              </span>
            </td>
            <button (click)="openModal('sell', stock)" class="padd">
              Sell
            </button>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="other-stocks-box">
      <h2>View Other Stocks</h2>
      <div class="stock-search">
        <input
          type="text"
          [(ngModel)]="searchQuery"
          placeholder="Search by ticker"
        />
        <button (click)="this.getMarketStock()">Search</button>
      </div>
      <div *ngIf="errorMessage" class="error_msg">
        {{ errorMessage }}
      </div>
      <table>
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Name</th>
            <th>Current Price</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="marketStockValues['stock_ticker']">
            <td>{{ marketStockValues["stock_ticker"] }}</td>
            <td>{{ marketStockValues["stock_name"] }}</td>
            <td>{{ marketStockValues["current_price"] }}</td>
            <button (click)="openModal('buy', marketStockValues)" class="buy-button">Buy</button>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!--<Buy/Sell Modal -->
  <div class="modal-backdrop" *ngIf="showModal">
    <div class="modal">
      <h2>
        {{ modalType === "buy" ? "Buy" : "Sell" }}
        {{
          modalType === "buy"
            ? selectedStock?.stock_ticker
            : selectedStock?.data.stock_ticker
        }}
      </h2>

      <label>Quantity:</label>
      <input type="number" [(ngModel)]="modalQuantity" min="1" />
      <td></td>
      <label for="bankAccount">Select Bank Account:</label>
      <select id="bankAccount" [(ngModel)]="selectedBankAccount">
        <option *ngFor="let bank of bankAccounts" [ngValue]="bank">
          {{ bank.bank_account_name }} ({{ bank.bank_account_type }}) - {{ bank.current_balance | currency }}
        </option>
      </select>

      <p *ngIf="modalQuantity && selectedStock">
        Total {{ modalType === "buy" ? "Cost" : "Return" }}:
        {{
          modalType === "sell"
            ? (selectedStock.data.current_price * modalQuantity | currency)
            : (selectedStock.current_price * modalQuantity | currency)
        }}
      </p>
      <div *ngIf="response" class="response-message">
        {{ response }}
      </div>
      <div class="modal-actions">
        <button (click)="confirmTransaction()">Confirm</button>
        <button (click)="closeModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>